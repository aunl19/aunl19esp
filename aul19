local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")

-- GUI setup
local gui = Instance.new("ScreenGui")
gui.Name = "BananaESP_TP"
gui.ResetOnSpawn = false
gui.Parent = game:GetService("CoreGui")

-- Helper
local function applyUICorner(inst, radius)
	local corner = Instance.new("UICorner")
	corner.CornerRadius = UDim.new(0, radius)
	corner.Parent = inst
end

local function addStroke(inst)
	local stroke = Instance.new("UIStroke")
	stroke.Thickness = 1.2
	stroke.Color = Color3.fromRGB(0, 0, 0)
	stroke.Parent = inst
end

local function hoverEffect(btn, normal, hover)
	btn.MouseEnter:Connect(function()
		btn.BackgroundColor3 = hover
	end)
	btn.MouseLeave:Connect(function()
		btn.BackgroundColor3 = normal
	end)
end

-- Avatar button
local avatarBtn = Instance.new("ImageButton")
avatarBtn.Size = UDim2.new(0, 60, 0, 60)
avatarBtn.Position = UDim2.new(0, 100, 0, 200)
avatarBtn.AnchorPoint = Vector2.new(0.5, 0.5)
avatarBtn.BackgroundTransparency = 1
avatarBtn.ZIndex = 10
avatarBtn.Image = ("https://www.roblox.com/headshot-thumbnail/image?userId=%d&width=420&height=420&format=png"):format(LocalPlayer.UserId)
applyUICorner(avatarBtn, 30)
avatarBtn.Parent = gui

-- Dragging logic
local dragging, dragStart, startPos
avatarBtn.InputBegan:Connect(function(input)
	if input.UserInputType == Enum.UserInputType.MouseButton1 then
		dragging = true
		dragStart = UserInputService:GetMouseLocation()
		startPos = avatarBtn.Position
		local conn
		conn = RunService.RenderStepped:Connect(function()
			if dragging then
				local delta = UserInputService:GetMouseLocation() - dragStart
				avatarBtn.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X,
					startPos.Y.Scale, startPos.Y.Offset + delta.Y)
			else
				conn:Disconnect()
			end
		end)
	end
end)

UserInputService.InputEnded:Connect(function(input)
	if input.UserInputType == Enum.UserInputType.MouseButton1 then
		dragging = false
	end
end)

-- Main menu
local menu = Instance.new("Frame")
menu.Size = UDim2.new(0, 320, 0, 280)
menu.Position = UDim2.new(0, 80, 0, 80)
menu.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
menu.Visible = false
applyUICorner(menu, 10)
addStroke(menu)
menu.Parent = gui

avatarBtn.MouseButton1Click:Connect(function()
	menu.Visible = not menu.Visible
end)

-- Tabs
local tabESP = Instance.new("TextButton", menu)
tabESP.Size = UDim2.new(0.5, 0, 0, 30)
tabESP.Text = "ESP"
tabESP.BackgroundColor3 = Color3.fromRGB(45, 45, 45)
tabESP.TextColor3 = Color3.new(1, 1, 1)
tabESP.Font = Enum.Font.GothamBold
applyUICorner(tabESP, 6)
addStroke(tabESP)
hoverEffect(tabESP, tabESP.BackgroundColor3, Color3.fromRGB(65, 65, 65))

local tabTP = tabESP:Clone()
tabTP.Text = "Teleport"
tabTP.Position = UDim2.new(0.5, 0, 0, 0)
tabTP.Parent = menu

-- Tab content
local espFrame = Instance.new("Frame", menu)
espFrame.Size = UDim2.new(1, 0, 1, -30)
espFrame.Position = UDim2.new(0, 0, 0, 30)
espFrame.BackgroundTransparency = 1

local tpFrame = espFrame:Clone()
tpFrame.Visible = false
tpFrame.Parent = menu

tabESP.MouseButton1Click:Connect(function()
	espFrame.Visible = true
	tpFrame.Visible = false
	tabESP.BackgroundColor3 = Color3.fromRGB(45, 45, 45)
	tabTP.BackgroundColor3 = Color3.fromRGB(35, 35, 35)
end)

tabTP.MouseButton1Click:Connect(function()
	espFrame.Visible = false
	tpFrame.Visible = true
	tabTP.BackgroundColor3 = Color3.fromRGB(45, 45, 45)
	tabESP.BackgroundColor3 = Color3.fromRGB(35, 35, 35)
end)

-- ESP button
local espAllButton = Instance.new("TextButton", espFrame)
espAllButton.Size = UDim2.new(1, -20, 0, 30)
espAllButton.Position = UDim2.new(0, 10, 0, 0)
espAllButton.Text = "ESP All: OFF"
espAllButton.Font = Enum.Font.GothamBold
espAllButton.TextColor3 = Color3.new(1, 1, 1)
espAllButton.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
applyUICorner(espAllButton, 6)
addStroke(espAllButton)
hoverEffect(espAllButton, espAllButton.BackgroundColor3, Color3.fromRGB(90, 90, 90))

-- ESP list
local PlayerList = Instance.new("ScrollingFrame", espFrame)
PlayerList.Size = UDim2.new(1, -20, 1, -50)
PlayerList.Position = UDim2.new(0, 10, 0, 40)
PlayerList.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
PlayerList.ScrollBarThickness = 6
PlayerList.CanvasSize = UDim2.new()
PlayerList.BorderSizePixel = 0
applyUICorner(PlayerList, 5)
addStroke(PlayerList)

local UIList = Instance.new("UIListLayout", PlayerList)
UIList.Padding = UDim.new(0, 4)

-- ESP logic
local espParts, highlights = {}, {}
local function clearESP()
	for part in pairs(espParts) do
		if part and part:FindFirstChild("ESPGui") then part.ESPGui:Destroy() end
	end
	for _, h in pairs(highlights) do if h then h:Destroy() end end
	espParts, highlights = {}, {}
end

local function addESP(part, name)
	local gui = Instance.new("BillboardGui")
	gui.Name = "ESPGui"
	gui.Size = UDim2.new(0, 100, 0, 20)
	gui.AlwaysOnTop = true
	gui.StudsOffset = Vector3.new(0, 2, 0)
	gui.Adornee = part
	gui.Parent = part

	local txt = Instance.new("TextLabel", gui)
	txt.Size = UDim2.new(1, 0, 1, 0)
	txt.BackgroundTransparency = 1
	txt.TextColor3 = Color3.new(1, 1, 1)
	txt.Text = name
	txt.TextScaled = true

	espParts[part] = true
end

local function addHighlight(char)
	local hl = Instance.new("Highlight")
	hl.FillColor = Color3.fromRGB(255, 255, 0)
	hl.OutlineColor = hl.FillColor
	hl.Adornee = char
	hl.Parent = char
	highlights[char] = hl
end

local espAll = false
espAllButton.MouseButton1Click:Connect(function()
	espAll = not espAll
	espAllButton.Text = espAll and "ESP All: ON" or "ESP All: OFF"
	clearESP()
	if espAll then
		for _, p in ipairs(Players:GetPlayers()) do
			if p ~= LocalPlayer and p.Character then
				local hrp = p.Character:FindFirstChild("HumanoidRootPart")
				if hrp then
					addESP(hrp, p.Name)
					addHighlight(p.Character)
				end
			end
		end
	end
end)

local function updatePlayerList()
	for _, c in ipairs(PlayerList:GetChildren()) do
if c:IsA("TextButton") then c:Destroy() end
	end
	for _, p in ipairs(Players:GetPlayers()) do
		if p ~= LocalPlayer then
			local b = Instance.new("TextButton", PlayerList)
			b.Size = UDim2.new(1, 0, 0, 30)
			b.Text = p.Name
			b.BackgroundColor3 = Color3.fromRGB(70, 70, 70)
			b.TextColor3 = Color3.new(1, 1, 1)
			b.Font = Enum.Font.Gotham
			applyUICorner(b, 5)
			hoverEffect(b, b.BackgroundColor3, Color3.fromRGB(100, 100, 100))
			b.MouseButton1Click:Connect(function()
				clearESP()
				local hrp = p.Character and p.Character:FindFirstChild("HumanoidRootPart")
				if hrp then
					addESP(hrp, p.Name)
					addHighlight(p.Character)
				end
			end)
		end
	end
	task.wait()
	PlayerList.CanvasSize = UDim2.new(0, 0, 0, UIList.AbsoluteContentSize.Y)
end

Players.PlayerAdded:Connect(updatePlayerList)
Players.PlayerRemoving:Connect(updatePlayerList)
updatePlayerList()

-- TELEPORT GUI
local dropdown = Instance.new("TextButton", tpFrame)
dropdown.Size = UDim2.new(1, -20, 0, 30)
dropdown.Position = UDim2.new(0, 10, 0, 10)
dropdown.Text = "Chọn người chơi"
dropdown.Font = Enum.Font.Gotham
dropdown.TextColor3 = Color3.new(1, 1, 1)
dropdown.BackgroundColor3 = Color3.fromRGB(80, 80, 80)
applyUICorner(dropdown, 5)
addStroke(dropdown)

local tpListFrame = Instance.new("ScrollingFrame", tpFrame)
tpListFrame.Size = UDim2.new(1, -20, 0, 100)
tpListFrame.Position = UDim2.new(0, 10, 0, 45)
tpListFrame.Visible = false
tpListFrame.ScrollBarThickness = 6
tpListFrame.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
applyUICorner(tpListFrame, 5)
addStroke(tpListFrame)

local tpLayout = Instance.new("UIListLayout", tpListFrame)
tpLayout.Padding = UDim.new(0, 2)

local selectedTP = nil
local function updateTPList()
	for _, c in ipairs(tpListFrame:GetChildren()) do
		if c:IsA("TextButton") then c:Destroy() end
	end
	for _, p in ipairs(Players:GetPlayers()) do
		if p ~= LocalPlayer then
			local b = Instance.new("TextButton", tpListFrame)
			b.Size = UDim2.new(1, 0, 0, 25)
			b.Text = p.Name
			b.Font = Enum.Font.Gotham
			b.TextColor3 = Color3.new(1, 1, 1)
			b.BackgroundColor3 = Color3.fromRGB(70, 70, 70)
			applyUICorner(b, 5)
			b.MouseButton1Click:Connect(function()
				selectedTP = p
				dropdown.Text = "Đã chọn: " .. p.Name
				tpListFrame.Visible = false
			end)
		end
	end
	task.wait()
	tpListFrame.CanvasSize = UDim2.new(0, 0, 0, tpLayout.AbsoluteContentSize.Y)
end

dropdown.MouseButton1Click:Connect(function()
	tpListFrame.Visible = not tpListFrame.Visible
end)

local tpButton = Instance.new("TextButton", tpFrame)
tpButton.Size = UDim2.new(1, -20, 0, 30)
tpButton.Position = UDim2.new(0, 10, 0, 160)
tpButton.Text = "Teleport"
tpButton.Font = Enum.Font.GothamBold
tpButton.TextColor3 = Color3.new(1, 1, 1)
tpButton.BackgroundColor3 = Color3.fromRGB(100, 100, 100)
applyUICorner(tpButton, 5)
hoverEffect(tpButton, tpButton.BackgroundColor3, Color3.fromRGB(130, 130, 130))

tpButton.MouseButton1Click:Connect(function()
if selectedTP and selectedTP.Character and selectedTP.Character:FindFirstChild("HumanoidRootPart") then
		LocalPlayer.Character:MoveTo(selectedTP.Character.HumanoidRootPart.Position + Vector3.new(0, 5, 0))
	else
		warn("Không thể teleport.")
	end
end)

Players.PlayerAdded:Connect(updateTPList)
Players.PlayerRemoving:Connect(updateTPList)
updateTPList()      
